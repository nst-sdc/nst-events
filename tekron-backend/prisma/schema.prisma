generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

model Participant {
    id           String    @id @default(uuid())
    email        String    @unique
    name         String
    password     String
    approved     Boolean   @default(false)
    qrCode       String?
    approvedById String?
    approvedAt   DateTime?
    createdAt    DateTime  @default(now())

    assignedEventId String?
    event           Event?  @relation(fields: [assignedEventId], references: [id])

    approvedBy        Admin?             @relation("AdminApprovals", fields: [approvedById], references: [id])
    approvals         ApprovalLog[]
    eventParticipants EventParticipant[]

    // New fields
    pushToken String? // Expo push token for notifications
    xp        Int     @default(0)
    level     Int     @default(1)

    // Relations
    badges ParticipantBadge[]
}

model Admin {
    id        String   @id @default(uuid())
    email     String   @unique
    name      String
    password  String
    createdAt DateTime @default(now())

    approvals     ApprovalLog[] @relation("AdminApprovalLogs")
    approvedUsers Participant[] @relation("AdminApprovals")

    // New field
    pushToken String?
}

model SuperAdmin {
    id        String   @id @default(uuid())
    email     String   @unique
    name      String
    password  String
    createdAt DateTime @default(now())
}

model ApprovalLog {
    id            String   @id @default(uuid())
    participantId String
    adminId       String
    approvedAt    DateTime @default(now())
    notes         String?

    participant Participant @relation(fields: [participantId], references: [id])
    admin       Admin       @relation("AdminApprovalLogs", fields: [adminId], references: [id])
}

enum EventStatus {
    UPCOMING
    LIVE
    PAUSED
    COMPLETED
    CANCELLED
}

model Event {
    id           String             @id @default(uuid())
    title        String
    description  String?
    location     String
    startTime    DateTime
    endTime      DateTime
    status       EventStatus        @default(UPCOMING)
    currentRound Int?
    createdAt    DateTime           @default(now())
    participants Participant[]
    leaderboard  EventParticipant[]

    venueId String?
    venue   Location? @relation(fields: [venueId], references: [id])
}

model Location {
    id       String  @id @default(uuid())
    name     String
    building String
    floor    String
    mapCode  String? // e.g. code to map overlay or image URL
    isPublic Boolean @default(true)
    events   Event[]
}

model EventParticipant {
    id            String   @id @default(uuid())
    participantId String
    eventId       String
    score         Int      @default(0)
    rank          Int?
    updatedAt     DateTime @default(now())

    participant Participant @relation(fields: [participantId], references: [id])
    event       Event       @relation(fields: [eventId], references: [id])
}

model Alert {
    id         String   @id @default(uuid())
    title      String
    message    String
    createdAt  DateTime @default(now())
    senderRole String // 'admin' or 'superadmin'
}

model Badge {
    id          String   @id @default(uuid())
    name        String
    description String?
    iconUrl     String?
    type        String // "participant", "winner", "volunteer", etc.
    createdAt   DateTime @default(now())

    awardedTo ParticipantBadge[]
}

model ParticipantBadge {
    id            String   @id @default(uuid())
    participantId String
    badgeId       String
    awardedAt     DateTime @default(now())

    participant Participant @relation(fields: [participantId], references: [id])
    badge       Badge       @relation(fields: [badgeId], references: [id])
}
